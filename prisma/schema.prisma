// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL
// ============================================
model User {
  id                String          @id @default(cuid())
  email             String          @unique
  emailVerified     DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // User preferences
  preferences       Json?           @default("{}")
  privacySettings   Json?           @default("{\"allowAI\": true, \"allowAnalytics\": true}")
  
  // Relationships
  entries           Entry[]
  weeklySummaries   WeeklySummary[]
  aiPrompts         AIPrompt[]
  
  @@map("users")
}

// ============================================
// JOURNAL ENTRY MODEL
// ============================================
model Entry {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Content
  content           String          @db.Text
  wordCount         Int             @default(0)
  
  // Local Analysis (AFINN)
  sentimentScore    Float?          // -5 to +5 from AFINN
  sentimentLabel    String?         // "very happy", "happy", "neutral", "sad", "depressed"
  themes            String[]        @default([])
  
  // Metadata
  analyzed          Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Privacy settings at time of entry creation
  allowAI           Boolean         @default(true) // Whether AI features were enabled when entry was created
  allowAnalytics    Boolean         @default(true) // Whether analytics were enabled when entry was created
  
  // Relationships
  analysis          Analysis?
  suggestions       AISuggestion[]
  
  @@index([userId, createdAt])
  @@map("entries")
}

// ============================================
// DETAILED ANALYSIS MODEL (Optional Deep Analysis)
// ============================================
model Analysis {
  id                String          @id @default(cuid())
  entryId           String          @unique
  entry             Entry           @relation(fields: [entryId], references: [id], onDelete: Cascade)
  
  // Sentiment details
  sentimentScore    Float
  sentimentLabel    String
  emotionalWords    Json            // {positive: ["happy", "excited"], negative: ["sad"]}
  
  // Theme details
  themes            Json            // {theme: frequency} e.g., {"work": 5, "family": 3}
  keyPhrases        String[]
  
  // Context
  contextSummary    String?         @db.Text
  
  // Metadata
  analyzedAt        DateTime        @default(now())
  
  @@map("analyses")
}

// ============================================
// AI SUGGESTION MODEL (Real-Time Companion)
// ============================================
model AISuggestion {
  id                String          @id @default(cuid())
  entryId           String
  entry             Entry           @relation(fields: [entryId], references: [id], onDelete: Cascade)
  
  // Suggestion details
  suggestionText    String          @db.Text
  triggerContext    String?         @db.Text // What triggered this suggestion
  
  // User interaction
  accepted          Boolean         @default(false)
  dismissed         Boolean         @default(false)
  
  // Metadata
  createdAt         DateTime        @default(now())
  
  @@index([entryId])
  @@map("ai_suggestions")
}

// ============================================
// WEEKLY SUMMARY MODEL
// ============================================
model WeeklySummary {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Time period
  weekStart         DateTime
  weekEnd            DateTime
  
  // Summary content (generated by Claude)
  summary           String          @db.Text
  topThemes         String[]
  correlations      Json?           // Discovered patterns
  
  // Aggregated data
  avgSentiment      Float
  entryCount        Int
  sentimentTrend    Float[]         @default([])
  
  // Metadata
  generatedAt       DateTime        @default(now())
  regenerated       Boolean         @default(false)
  
  @@index([userId, weekStart])
  @@unique([userId, weekStart])
  @@map("weekly_summaries")
}

// ============================================
// AI PROMPT MODEL (Daily Prompts)
// ============================================
model AIPrompt {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Prompt details
  promptText        String          @db.Text
  context           Json?           // What context was used to generate this
  
  // Progressive prompts tracking
  entryCount        Int?            // Which entry number this prompt is for (1st, 2nd, 3rd, etc.)
  relatedEntryId    String?         // ID of entry that triggered this prompt generation
  
  // User interaction
  used              Boolean         @default(false)
  usedAt            DateTime?
  
  // Metadata
  generatedAt       DateTime        @default(now())
  expiresAt         DateTime        // Prompts expire after 24 hours
  
  @@index([userId, generatedAt])
  @@index([userId, entryCount, generatedAt])
  @@map("ai_prompts")
}
